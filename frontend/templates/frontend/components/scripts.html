<script>
// Funcionalidad para filtrar horarios
function filtrarHorarios(cursoId) {
  const horarios = document.querySelectorAll('.horario-curso');
  const botones = document.querySelectorAll('[onclick^="filtrarHorarios"]');
  
  // Actualizar botones
  botones.forEach(btn => {
    btn.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors';
  });
  
  if (cursoId === 'todos') {
    // Mostrar todos los horarios
    horarios.forEach(horario => {
      horario.style.display = 'block';
    });
    botones[0].className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors';
  } else {
    // Mostrar solo el horario seleccionado
    horarios.forEach(horario => {
      if (horario.dataset.cursoId === cursoId) {
        horario.style.display = 'block';
      } else {
        horario.style.display = 'none';
      }
    });
    // Actualizar bot√≥n activo
    const botonActivo = document.querySelector(`[onclick="filtrarHorarios('${cursoId}')"]`);
    if (botonActivo) {
      botonActivo.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors';
    }
  }
}

// Cargar estad√≠sticas en tiempo real
function cargarEstadisticas() {
  fetch('/estadisticas-ajax/')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error al cargar estad√≠sticas:', data.error);
        return;
      }
      
      // Actualizar estad√≠sticas
      document.getElementById('total-cursos').textContent = data.total_cursos;
      document.getElementById('total-profesores').textContent = data.total_profesores;
      document.getElementById('total-horarios').textContent = data.total_horarios;
      document.getElementById('total-bloques').textContent = data.total_aulas;
      
      // Actualizar profesores sin disponibilidad
      const container = document.getElementById('profesores-sin-disponibilidad');
      if (data.profesores_sin_disponibilidad > 0) {
        container.innerHTML = `<li class="text-orange-600">‚ö†Ô∏è ${data.profesores_sin_disponibilidad} profesores sin disponibilidad</li>`;
      } else {
        container.innerHTML = '<li class="text-green-600">‚úÖ Todos los profesores tienen disponibilidad registrada</li>';
      }
    })
    .catch(error => {
      console.error('Error al cargar estad√≠sticas:', error);
    });
}

// Sistema de tooltips para informaci√≥n de par√°metros
function initTooltips() {
  const tooltipTriggers = document.querySelectorAll('.info-tooltip-trigger');
  const tooltip = document.getElementById('tooltip');
  
  tooltipTriggers.forEach(trigger => {
    trigger.addEventListener('mouseenter', function(e) {
      const tooltipText = this.getAttribute('data-tooltip');
      if (tooltipText && tooltip) {
        tooltip.textContent = tooltipText;
        tooltip.classList.remove('hidden');
        
        // Posicionar tooltip
        const rect = this.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 10) + 'px';
      }
    });
    
    trigger.addEventListener('mouseleave', function() {
      if (tooltip) {
        tooltip.classList.add('hidden');
      }
    });
  });
  
  // Ocultar tooltip al mover el mouse fuera
  document.addEventListener('mouseleave', function() {
    if (tooltip) {
      tooltip.classList.add('hidden');
    }
  });
}

// Sistema de configuraci√≥n r√°pida de par√°metros
function initConfiguracionRapida() {
  const configButtons = document.querySelectorAll('.config-rapida-btn');
  
  const configuraciones = {
    estable: {
      poblacion_size: 30,
      generaciones: 80,
      timeout_seg: 120,
      prob_cruce: 0.8,
      prob_mutacion: 0.12,
      elite: 3,
      paciencia: 20,
      workers: 1,
      semilla: 42
    },
    rapida: {
      poblacion_size: 20,
      generaciones: 40,
      timeout_seg: 60,
      prob_cruce: 0.7,
      prob_mutacion: 0.1,
      elite: 2,
      paciencia: 10,
      workers: 1,
      semilla: 42
    },
    calidad: {
      poblacion_size: 100,
      generaciones: 300,
      timeout_seg: 300,
      prob_cruce: 0.9,
      prob_mutacion: 0.2,
      elite: 5,
      paciencia: 30,
      workers: 2,
      semilla: 42
    }
  };
  
  // Valores por defecto originales
  const valoresDefault = {
    poblacion_size: 80,
    generaciones: 500,
    timeout_seg: 180,
    prob_cruce: 0.85,
    prob_mutacion: 0.25,
    elite: 4,
    paciencia: 20,
    workers: 1,
    semilla: 42
  };
  
  configButtons.forEach(button => {
    button.addEventListener('click', function() {
      const configType = this.getAttribute('data-config');
      const config = configuraciones[configType];
      
      if (config) {
        // Aplicar configuraci√≥n
        Object.keys(config).forEach(key => {
          const input = document.querySelector(`input[name="${key}"]`);
          if (input) {
            input.value = config[key];
            // Agregar efecto visual
            input.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => {
              input.classList.remove('ring-2', 'ring-green-500');
            }, 1000);
          }
        });
        
        // Mostrar mensaje de confirmaci√≥n
        mostrarNotificacion(`‚úÖ Configuraci√≥n "${configType}" aplicada`, 'success');
      }
    });
  });
  
  // Bot√≥n para restaurar valores por defecto
  const btnRestaurar = document.getElementById('restaurar-default');
  if (btnRestaurar) {
    btnRestaurar.addEventListener('click', function() {
      Object.keys(valoresDefault).forEach(key => {
        const input = document.querySelector(`input[name="${key}"]`);
        if (input) {
          input.value = valoresDefault[key];
          // Agregar efecto visual
          input.classList.add('ring-2', 'ring-blue-500');
          setTimeout(() => {
            input.classList.remove('ring-2', 'ring-blue-500');
          }, 1000);
        }
      });
      
      mostrarNotificacion('üîÑ Valores por defecto restaurados', 'info');
    });
  }
}

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
  const notificacion = document.createElement('div');
  notificacion.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
  
  // Estilos seg√∫n tipo
  if (tipo === 'success') {
    notificacion.className += ' bg-green-500 text-white';
  } else if (tipo === 'error') {
    notificacion.className += ' bg-red-500 text-white';
  } else {
    notificacion.className += ' bg-blue-500 text-white';
  }
  
  notificacion.textContent = mensaje;
  document.body.appendChild(notificacion);
  
  // Animar entrada
  setTimeout(() => {
    notificacion.classList.remove('translate-x-full');
  }, 100);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    notificacion.classList.add('translate-x-full');
    setTimeout(() => {
      if (notificacion.parentNode) {
        notificacion.parentNode.removeChild(notificacion);
      }
    }, 300);
  }, 3000);
}

// Manejo del formulario de generaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('form-generacion');
  const btnGenerar = document.getElementById('btn-generar');
  const loadingIndicator = document.getElementById('loading-indicator');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      // Mostrar indicador de carga
      btnGenerar.disabled = true;
      btnGenerar.textContent = 'Generando...';
      loadingIndicator.classList.remove('hidden');
      
      // El formulario se enviar√° normalmente
    });
  }
  
  // Inicializar tooltips
  initTooltips();
  
  // Inicializar configuraci√≥n r√°pida
  initConfiguracionRapida();
  
  // Cargar estad√≠sticas iniciales
  cargarEstadisticas();
  
  // Actualizar estad√≠sticas cada 30 segundos
  setInterval(cargarEstadisticas, 30000);
});

// Funcionalidad para cargar horarios din√°micamente
function cargarHorarioAjax(tipo, id) {
  const container = document.getElementById('horario-container');
  if (!container) return;
  
  container.innerHTML = '<div class="text-center p-8"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div><p class="mt-2">Cargando horario...</p></div>';
  
  fetch(`/horario-ajax/?tipo=${tipo}&id=${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        container.innerHTML = `<div class="text-center p-8 text-red-600">Error: ${data.error}</div>`;
        return;
      }
      
      // Renderizar horario
      renderizarHorario(data, container);
    })
    .catch(error => {
      container.innerHTML = `<div class="text-center p-8 text-red-600">Error al cargar horario: ${error}</div>`;
    });
}

function renderizarHorario(data, container) {
  let html = `<h2 class="text-2xl font-bold text-blue-900 mb-6">${data.titulo}</h2>`;
  html += '<div class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300">';
  
  // Encabezado
  html += '<thead><tr class="bg-gray-100"><th class="border border-gray-300 p-2 text-center font-semibold">Hora</th>';
  data.dias.forEach(dia => {
    html += `<th class="border border-gray-300 p-2 text-center font-semibold">${dia.charAt(0).toUpperCase() + dia.slice(1)}</th>`;
  });
  html += '</tr></thead>';
  
  // Cuerpo
  html += '<tbody>';
  data.bloques.forEach(bloque => {
    html += `<tr><td class="border border-gray-300 p-2 text-center font-medium bg-gray-50">Bloque ${bloque}</td>`;
    
    data.dias.forEach(dia => {
      const horario = data.horarios.find(h => h.dia === dia && h.bloque === bloque);
      html += '<td class="border border-gray-300 p-2 text-center min-h-[60px]">';
      
      if (horario) {
        html += `<div class="text-sm p-1 rounded bg-blue-100">
          <div class="font-semibold text-blue-700">${horario.materia}</div>
          <div class="text-gray-600 text-xs">${horario.profesor}</div>
          <div class="text-gray-500 text-xs">${horario.aula}</div>
        </div>`;
      }
      
      html += '</td>';
    });
    
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  
  container.innerHTML = html;
}

// Mejoras de accesibilidad
document.addEventListener('DOMContentLoaded', function() {
  // Agregar navegaci√≥n por teclado
  const botones = document.querySelectorAll('button, a');
  botones.forEach(boton => {
    boton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
  });
  
  // Agregar focus visible
  const focusableElements = document.querySelectorAll('button, a, input, select, textarea');
  focusableElements.forEach(element => {
    element.addEventListener('focus', function() {
      this.style.outline = '2px solid #3b82f6';
      this.style.outlineOffset = '2px';
    });
    
    element.addEventListener('blur', function() {
      this.style.outline = '';
      this.style.outlineOffset = '';
    });
  });
});
</script>