<script>
// Funcionalidad para filtrar horarios
function filtrarHorarios(cursoId) {
  const horarios = document.querySelectorAll('.horario-curso');
  const botones = document.querySelectorAll('[onclick^="filtrarHorarios"]');
  
  // Actualizar botones
  botones.forEach(btn => {
    btn.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors';
  });
  
  if (cursoId === 'todos') {
    // Mostrar todos los horarios
    horarios.forEach(horario => {
      horario.style.display = 'block';
    });
    botones[0].className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors';
  } else {
    // Mostrar solo el horario seleccionado
    horarios.forEach(horario => {
      if (horario.dataset.cursoId === cursoId) {
        horario.style.display = 'block';
      } else {
        horario.style.display = 'none';
      }
    });
    // Actualizar bot√≥n activo
    const botonActivo = document.querySelector(`[onclick="filtrarHorarios('${cursoId}')"]`);
    if (botonActivo) {
      botonActivo.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors';
    }
  }
}

// Cargar estad√≠sticas en tiempo real
function cargarEstadisticas() {
  fetch('/estadisticas-ajax/')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error al cargar estad√≠sticas:', data.error);
        return;
      }
      
      // Actualizar estad√≠sticas
      document.getElementById('total-cursos').textContent = data.total_cursos;
      document.getElementById('total-profesores').textContent = data.total_profesores;
      document.getElementById('total-horarios').textContent = data.total_horarios;
      document.getElementById('total-bloques').textContent = data.total_aulas;
      
      // Actualizar profesores sin disponibilidad
      const container = document.getElementById('profesores-sin-disponibilidad');
      if (data.profesores_sin_disponibilidad > 0) {
        container.innerHTML = `<li class="text-orange-600">‚ö† ${data.profesores_sin_disponibilidad} profesores sin disponibilidad</li>`;
      } else {
        container.innerHTML = '<li class="text-green-600">‚úì Todos los profesores tienen disponibilidad registrada</li>';
      }
      
      // Si hay horarios, ocultar el indicador de progreso
      if (data.total_horarios > 0) {
        document.getElementById('progreso-algoritmo').classList.add('hidden');
      }
    })
    .catch(error => {
      console.error('Error al cargar estad√≠sticas:', error);
    });
}

// Sistema de tooltips para informaci√≥n de par√°metros
function initTooltips() {
  const tooltipTriggers = document.querySelectorAll('.info-tooltip-trigger');
  const tooltip = document.getElementById('tooltip');
  
  tooltipTriggers.forEach(trigger => {
    trigger.addEventListener('mouseenter', function(e) {
      const tooltipText = this.getAttribute('data-tooltip');
      if (tooltipText && tooltip) {
        tooltip.textContent = tooltipText;
        tooltip.classList.remove('hidden');
        
        // Posicionar tooltip
        const rect = this.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 10) + 'px';
      }
    });
    
    trigger.addEventListener('mouseleave', function() {
      if (tooltip) {
        tooltip.classList.add('hidden');
      }
    });
  });
  
  // Ocultar tooltip al mover el mouse fuera
  document.addEventListener('mouseleave', function() {
    if (tooltip) {
      tooltip.classList.add('hidden');
    }
  });
}

// Monitorear progreso del algoritmo gen√©tico
let monitoreoProgreso = null;

function iniciarMonitoreoProgreso() {
  if (monitoreoProgreso) return;
  
  // Mostrar indicador de progreso
  document.getElementById('progreso-algoritmo').classList.remove('hidden');
  
  // Actualizar cada 2 segundos
  monitoreoProgreso = setInterval(() => {
    fetch('/progreso-ajax/')
      .then(response => response.json())
      .then(data => {
        if (data.estado === 'finalizado') {
          // Algoritmo termin√≥ - DETENER POLLING
          clearInterval(monitoreoProgreso);
          monitoreoProgreso = null;
          
          // Limpiar cache de progreso
          fetch('/limpiar-cache-progreso/')
            .then(response => response.json())
            .then(data => {
              console.log('Cache de progreso limpiado:', data.mensaje);
            })
            .catch(error => {
              console.log('Error limpiando cache:', error);
            });
          
          // Ocultar indicador de progreso
          document.getElementById('progreso-algoritmo').classList.add('hidden');
          
          // Actualizar bot√≥n de generaci√≥n
          const btnGenerar = document.getElementById('btn-generar');
          if (btnGenerar) {
            btnGenerar.disabled = false;
            btnGenerar.textContent = 'Generar Horarios';
            btnGenerar.className = 'w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors';
          }
          
          // Ocultar indicador de carga
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
          }
          
          // Recargar estad√≠sticas para mostrar horarios
          cargarEstadisticas();
          
          // Mostrar mensaje de √©xito
          mostrarMensaje('‚úÖ Horarios generados exitosamente!', 'success');
          
          // Evitar recarga: ya actualizamos estad√≠sticas y mostramos mensaje
          
        } else if (data.estado === 'en_progreso') {
          // Actualizar indicadores de progreso
          const generacion = data.generacion || 0;
          const objetivo = data.objetivo || 100;
          const progreso = Math.min((generacion / objetivo) * 100, 100);
          
          document.getElementById('generacion-actual').textContent = generacion;
          document.getElementById('fitness-actual').textContent = (data.mejor_fitness || 0).toFixed(1);
          document.getElementById('horarios-parciales').textContent = data.horarios_parciales || 0;
          document.getElementById('ocupacion-actual').textContent = (data.fill_pct || 0).toFixed(1) + '%';
          document.getElementById('progreso-porcentaje').textContent = Math.round(progreso) + '%';
          document.getElementById('barra-progreso').style.width = progreso + '%';
          
          // Actualizar estado
          document.getElementById('estado-texto').textContent = `Generaci√≥n ${generacion}/${objetivo}`;
          document.getElementById('estado-detallado').textContent = data.mensaje || `Fitness: ${(data.mejor_fitness || 0).toFixed(1)}`;
          
          // Calcular tiempo estimado
          if (generacion > 0) {
            const tiempoPorGen = 2; // segundos estimados por generaci√≥n
            const generacionesRestantes = objetivo - generacion;
            const tiempoEstimado = Math.round(generacionesRestantes * tiempoPorGen / 60);
            document.getElementById('tiempo-estimado').textContent = `${tiempoEstimado} min`;
          }
        } else if (data.estado === 'sin_datos' || data.estado === 'error') {
          // No hay proceso activo - DETENER POLLING
          clearInterval(monitoreoProgreso);
          monitoreoProgreso = null;
          
          // Ocultar indicador de progreso
          document.getElementById('progreso-algoritmo').classList.add('hidden');
          
          // Restaurar bot√≥n de generaci√≥n
          const btnGenerar = document.getElementById('btn-generar');
          if (btnGenerar) {
            btnGenerar.disabled = false;
            btnGenerar.textContent = 'Generar Horarios';
            btnGenerar.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors';
          }
          
          // Ocultar indicador de carga
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
          }
        }
      })
      .catch(error => {
        console.error('Error monitoreando progreso:', error);
        
        // En caso de error, detener polling despu√©s de varios intentos fallidos
        if (monitoreoProgreso) {
          clearInterval(monitoreoProgreso);
          monitoreoProgreso = null;
          
          // Ocultar indicador de progreso
          document.getElementById('progreso-algoritmo').classList.add('hidden');
          
          // Restaurar bot√≥n de generaci√≥n
          const btnGenerar = document.getElementById('btn-generar');
          if (btnGenerar) {
            btnGenerar.disabled = false;
            btnGenerar.textContent = 'Generar Horarios';
            btnGenerar.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors';
          }
          
          // Ocultar indicador de carga
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
          }
        }
      });
  }, 2000);
}

function mostrarMensaje(mensaje, tipo) {
  // Crear mensaje temporal
  const div = document.createElement('div');
  div.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
    tipo === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
  }`;
  div.textContent = mensaje;
  document.body.appendChild(div);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    div.remove();
  }, 3000);
}

// Sistema de configuraci√≥n r√°pida de par√°metros
function initConfiguracionRapida() {
  const configButtons = document.querySelectorAll('.config-rapida-btn');
  
  const configuraciones = {
    estable: {
      poblacion_size: 40,
      generaciones: 80,
      timeout_seg: 90,
      prob_cruce: 0.8,
      prob_mutacion: 0.15,
      elite: 3,
      paciencia: 15,
      workers: 1,
      semilla: 42
    },
    rapida: {
      poblacion_size: 25,
      generaciones: 60,
      timeout_seg: 45,
      prob_cruce: 0.75,
      prob_mutacion: 0.2,
      elite: 2,
      paciencia: 8,
      workers: 1,
      semilla: 42
    },
    calidad: {
      poblacion_size: 80,
      generaciones: 1000,
      timeout_seg: 600,
      prob_cruce: 0.9,
      prob_mutacion: 0.05,
      elite: 5,
      paciencia: 50,
      workers: 1,
      semilla: Math.floor(Math.random() * 999999) + 1, // Semilla aleatoria para diversidad
    }
  };
  
  // Valores por defecto originales
  const valoresDefault = {
    poblacion_size: 80,
    generaciones: 500,
    timeout_seg: 180,
    prob_cruce: 0.85,
    prob_mutacion: 0.25,
    elite: 4,
    paciencia: 20,
    workers: 1,
    semilla: 42
  };
  
  configButtons.forEach(button => {
    button.addEventListener('click', function() {
      const configType = this.getAttribute('data-config');
      const config = configuraciones[configType];
      
      if (config) {
        // Aplicar configuraci√≥n
        Object.keys(config).forEach(key => {
          const input = document.querySelector(`input[name="${key}"]`);
          if (input) {
            // Para la configuraci√≥n de calidad, generar nueva semilla aleatoria
            if (configType === 'calidad' && key === 'semilla') {
              input.value = Math.floor(Math.random() * 999999) + 1;
            } else {
              input.value = config[key];
            }
            // Agregar efecto visual
            input.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => {
              input.classList.remove('ring-2', 'ring-green-500');
            }, 1000);
          }
        });
        
        // Mostrar mensaje de confirmaci√≥n
        mostrarNotificacion(`‚úÖ Configuraci√≥n "${configType}" aplicada`, 'success');
      }
    });
  });
  
  // Bot√≥n para restaurar valores por defecto
  const btnRestaurar = document.getElementById('restaurar-default');
  if (btnRestaurar) {
    btnRestaurar.addEventListener('click', function() {
      Object.keys(valoresDefault).forEach(key => {
        const input = document.querySelector(`input[name="${key}"]`);
        if (input) {
          input.value = valoresDefault[key];
          // Agregar efecto visual
          input.classList.add('ring-2', 'ring-blue-500');
          setTimeout(() => {
            input.classList.remove('ring-2', 'ring-blue-500');
          }, 1000);
        }
      });
      
      mostrarNotificacion('üîÑ Valores por defecto restaurados', 'info');
    });
  }
}

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
  const notificacion = document.createElement('div');
  notificacion.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
  
  // Estilos seg√∫n tipo
  if (tipo === 'success') {
    notificacion.className += ' bg-green-500 text-white';
  } else if (tipo === 'error') {
    notificacion.className += ' bg-red-500 text-white';
  } else {
    notificacion.className += ' bg-blue-500 text-white';
  }
  
  notificacion.textContent = mensaje;
  document.body.appendChild(notificacion);
  
  // Animar entrada
  setTimeout(() => {
    notificacion.classList.remove('translate-x-full');
  }, 100);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    notificacion.classList.add('translate-x-full');
    setTimeout(() => {
      if (notificacion.parentNode) {
        notificacion.parentNode.removeChild(notificacion);
      }
    }, 300);
  }, 3000);
}

// Manejo del formulario de generaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('form-generacion');
  const btnGenerar = document.getElementById('btn-generar');
  const loadingIndicator = document.getElementById('loading-indicator');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      // Mostrar indicador de carga
      btnGenerar.disabled = true;
      btnGenerar.textContent = 'Generando...';
      loadingIndicator.classList.remove('hidden');
      
      // Enviar formulario por AJAX para evitar redirecci√≥n
      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: formData
      })
      .then(async (response) => {
        let data = {};
        try { data = await response.json(); } catch (_) {}
        if (!response.ok || data.ok === false) {
          const msg = data.mensaje || 'Error al iniciar la generaci√≥n';
          mostrarMensaje(`‚ùå ${msg}`, 'error');
          btnGenerar.disabled = false;
          btnGenerar.textContent = 'Generar Horarios';
          loadingIndicator.classList.add('hidden');
          return;
        }
        // Iniciar monitoreo de progreso despu√©s de un segundo
        setTimeout(() => {
          iniciarMonitoreoProgreso();
        }, 1000);
      })
      .catch((err) => {
        mostrarMensaje(`‚ùå Error de red: ${err}`, 'error');
        btnGenerar.disabled = false;
        btnGenerar.textContent = 'Generar Horarios';
        loadingIndicator.classList.add('hidden');
      });
    });
  }
  
  // Inicializar tooltips
  initTooltips();
  
  // Inicializar configuraci√≥n r√°pida
  initConfiguracionRapida();
  
  // Cargar estad√≠sticas iniciales
  cargarEstadisticas();
  
  // Actualizar estad√≠sticas cada 30 segundos
  setInterval(cargarEstadisticas, 30000);
  
  // Verificar si hay una tarea en progreso al cargar
  fetch('/progreso-ajax/')
    .then(response => response.json())
    .then(data => {
        if (data.estado === 'en_progreso') {
          iniciarMonitoreoProgreso();
        } else if (data.estado === 'finalizado') {
          // Manejar finalizaci√≥n inmediata (modo eager/local) para dar feedback al usuario
          fetch('/limpiar-cache-progreso/').catch(() => {});
          cargarEstadisticas();
          mostrarMensaje('‚úÖ Horarios generados exitosamente!', 'success');
          // No recargar para evitar bucles si el cache tarda en limpiarse
        }
    })
    .catch(console.error);
});
// Funcionalidad para cargar horarios din√°micamente
function cargarHorarioAjax(tipo, id) {
  const container = document.getElementById('horario-container');
  if (!container) return;
  if (!id || String(id).trim() === '') {
    container.innerHTML = '<div class="text-center p-6 text-yellow-400">Ingresa un ID v√°lido.</div>';
    return;
  }
  
  container.innerHTML = '<div class="text-center p-8"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div><p class="mt-2">Cargando horario...</p></div>';
  
  fetch(`/horario-ajax/?tipo=${tipo}&id=${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        container.innerHTML = `<div class="text-center p-8 text-red-600">Error: ${data.error}</div>`;
        return;
      }
      
      // Renderizar horario
      renderizarHorario(data, container);
    })
    .catch(error => {
      container.innerHTML = `<div class="text-center p-8 text-red-600">Error al cargar horario: ${error}</div>`;
    });
}

function renderizarHorario(data, container) {
  let html = `<h2 class="text-2xl font-bold mb-6">${data.titulo}</h2>`;
  html += '<div class="overflow-x-auto"><table class="w-full border-collapse border border-white/10 bg-white/5 rounded-xl">';
  
  html += '<thead><tr class="bg-white/10"><th class="border border-white/10 p-2 text-center font-semibold">Hora</th>';
  data.dias.forEach(dia => {
    html += `<th class="border border-white/10 p-2 text-center font-semibold capitalize">${dia}</th>`;
  });
  html += '</tr></thead>';
  
  html += '<tbody>';
  data.bloques.forEach(bloque => {
    html += `<tr class="odd:bg-white/0 even:bg-white/5"><td class="border border-white/10 p-2 text-center font-medium">Bloque ${bloque}</td>`;
    
    data.dias.forEach(dia => {
      const horario = data.horarios.find(h => h.dia === dia && h.bloque === bloque);
      html += '<td class="border border-white/10 p-2 text-center h-24 align-middle">';
      
      if (horario) {
        const palette = [
          'from-rose-400/15 to-amber-300/10',
          'from-fuchsia-400/15 to-rose-300/10',
          'from-sky-400/15 to-cyan-300/10',
          'from-emerald-400/15 to-lime-300/10',
          'from-indigo-400/15 to-blue-300/10',
          'from-violet-400/15 to-purple-300/10',
          'from-teal-400/15 to-emerald-300/10',
          'from-orange-400/15 to-yellow-300/10'
        ];
        const idx = Math.abs((horario.materia || '').split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % palette.length;
        const grad = palette[idx];
        html += `<div class="text-sm p-2 rounded-xl border border-white/10 bg-gradient-to-br ${grad} shadow-sm shadow-black/10 ring-1 ring-white/10 h-20 w-full flex flex-col items-center justify-center">
          <div class="font-semibold text-white leading-tight text-center drop-shadow">${horario.materia}</div>
          <div class="text-gray-100/90 text-xs leading-tight text-center">${horario.profesor}</div>
          <div class="text-gray-200/90 text-xs leading-tight text-center">${horario.aula}</div>
        </div>`;
      }
      
      html += '</td>';
    });
    
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  
  container.innerHTML = html;
}

// Configurar bot√≥n de detener algoritmo
document.addEventListener('DOMContentLoaded', function() {
  const btnDetener = document.getElementById('detener-algoritmo');
  if (btnDetener) {
    btnDetener.addEventListener('click', function() {
      if (confirm('¬øEst√°s seguro de que quieres detener la generaci√≥n de horarios?')) {
        // Detener monitoreo
        if (monitoreoProgreso) {
          clearInterval(monitoreoProgreso);
          monitoreoProgreso = null;
        }
        
        // Ocultar indicador de progreso
        document.getElementById('progreso-algoritmo').classList.add('hidden');
        
        // Mostrar mensaje
        mostrarMensaje('‚ñ† Generaci√≥n detenida por el usuario', 'error');
      }
    });
  }
  
  // Mejoras de accesibilidad
  // Agregar navegaci√≥n por teclado
  const botones = document.querySelectorAll('button, a');
  botones.forEach(boton => {
    boton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
  });
  
  // Agregar focus visible
  const focusableElements = document.querySelectorAll('button, a, input, select, textarea');
  focusableElements.forEach(element => {
    element.addEventListener('focus', function() {
      this.style.outline = '2px solid #3b82f6';
      this.style.outlineOffset = '2px';
    });
    
    element.addEventListener('blur', function() {
      this.style.outline = '';
      this.style.outlineOffset = '';
    });
  });
});

function initProgresoGA() {
  const overlayId = 'overlay-progreso-ga';
  let overlay = document.getElementById(overlayId);
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = overlayId;
    overlay.style.position = 'fixed';
    overlay.style.bottom = '16px';
    overlay.style.right = '16px';
    overlay.style.background = 'rgba(17,24,39,0.95)';
    overlay.style.color = '#fff';
    overlay.style.padding = '12px 16px';
    overlay.style.borderRadius = '8px';
    overlay.style.boxShadow = '0 10px 15px -3px rgba(0,0,0,0.1)';
    overlay.style.zIndex = '9999';
    overlay.style.minWidth = '260px';
    overlay.innerHTML = `
      <div style="font-weight:600; margin-bottom:6px;">Generaci√≥n: <span id="ga-gen">-</span>/<span id="ga-obj">-</span></div>
      <div style="height:8px; background:#374151; border-radius:6px; overflow:hidden; margin-bottom:8px;">
        <div id="ga-bar" style="height:8px; width:0%; background:#10B981;"></div>
      </div>
      <div style="font-size:12px; opacity:.9;">
        <div>Fitness: <span id="ga-best">-</span> (avg <span id="ga-avg">-</span>)</div>
        <div>Ocupaci√≥n: <span id="ga-fill">-</span>%</div>
        <div>Reparados acum: <span id="ga-rep">0</span> ¬∑ Descartados acum: <span id="ga-des">0</span></div>
        <div>Evaluados acum: <span id="ga-ev">0</span> ¬∑ V√°lidos acum (horarios): <span id="ga-val">0</span></div>
      </div>`;
    document.body.appendChild(overlay);
  }
  function updateOverlay(d) {
    const gen = d.generacion ?? 0;
    const obj = d.objetivo ?? 0;
    document.getElementById('ga-gen').textContent = gen;
    document.getElementById('ga-obj').textContent = obj || '-';
    document.getElementById('ga-best').textContent = d.mejor_fitness?.toFixed ? d.mejor_fitness.toFixed(2) : d.mejor_fitness;
    document.getElementById('ga-avg').textContent = d.fitness_promedio?.toFixed ? d.fitness_promedio.toFixed(2) : d.fitness_promedio;
    document.getElementById('ga-fill').textContent = d.ocupacion_pct?.toFixed ? d.ocupacion_pct.toFixed(1) : d.ocupacion_pct;
    const pct = (obj && obj > 0) ? Math.max(0, Math.min(100, (gen / obj) * 100)) : 0;
    document.getElementById('ga-bar').style.width = pct + '%';
    if (typeof d.reparados_acum !== 'undefined') document.getElementById('ga-rep').textContent = d.reparados_acum;
    if (typeof d.descartados_acum !== 'undefined') document.getElementById('ga-des').textContent = d.descartados_acum;
    if (typeof d.evaluados_acum !== 'undefined') document.getElementById('ga-ev').textContent = d.evaluados_acum;
    if (typeof d.validos_acum !== 'undefined') document.getElementById('ga-val').textContent = d.validos_acum;
  }
  async function poll() {
    try {
      const res = await fetch('/progreso-ajax/');
      const data = await res.json();
      if (data.estado === 'en_progreso') {
        updateOverlay(data);
      } else if (data.estado === 'finalizado') {
        updateOverlay(data);
        const bar = document.getElementById('ga-bar');
        if (bar) bar.style.background = '#10B981'; // Verde para completado
        const gen = document.getElementById('ga-gen');
        if (gen) gen.textContent = data.generacion;
        
        // Limpiar cache de progreso
        fetch('/limpiar-cache-progreso/')
          .then(response => response.json())
          .then(data => {
            console.log('Cache de progreso limpiado:', data.mensaje);
          })
          .catch(error => {
            console.log('Error limpiando cache:', error);
          });
        
        // DETENER POLLING cuando termine
        if (window.__gaPoller) {
          clearInterval(window.__gaPoller);
          window.__gaPoller = null;
        }
        
        // Ocultar overlay despu√©s de 3 segundos
        setTimeout(() => {
          const overlay = document.getElementById(overlayId);
          if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 300);
          }
        }, 3000);
        
      } else if (data.estado === 'sin_datos' || data.estado === 'error') {
        // DETENER POLLING si no hay ejecuciones
        if (window.__gaPoller) {
          clearInterval(window.__gaPoller);
          window.__gaPoller = null;
        }
        
        // Ocultar overlay
        document.getElementById(overlayId)?.remove();
      }
    } catch (e) {
      // Silencioso
    }
  }
  // Polling cada 2s
  poll();
  window.__gaPoller = setInterval(poll, 2000);
}
// Auto iniciar en dashboard
if (window.location.pathname.startsWith('/dashboard')) {
  document.addEventListener('DOMContentLoaded', initProgresoGA);
  document.addEventListener('DOMContentLoaded', initDragAndDrop);
}

function initDragAndDrop() {
  let dragItem = null;
  let origin = null;
  let hover = null;

  function slotOcupado(slot) {
    return !!slot.querySelector('.draggable-item');
  }
  function hayConflictoProfesor(profesor, dia, bloque, ignorarIds = new Set(), originCurso = null) {
    const items = document.querySelectorAll('.draggable-item');
    for (const it of items) {
      if (ignorarIds.has(it.dataset.id)) continue;
      if (it.dataset.profesor !== profesor) continue;
      const parent = it.closest('.slot-celda');
      if (!parent) continue;
      // Conflicto si el mismo profe ya est√° en ese d√≠a/bloque en OTRO curso
      if (parent.dataset.dia === dia && parent.dataset.bloque === bloque) {
        if (!originCurso || parent.dataset.curso !== originCurso) {
          return true;
        }
      }
    }
    return false;
  }
  function esDropPermitido(item, slot) {
    if (!item || !slot || !origin) return false;
    const profesor = item.dataset.profesor;
    const dia = slot.dataset.dia;
    const bloque = slot.dataset.bloque;
    const originCurso = origin.dataset.curso;
    const targetCurso = slot.dataset.curso;
    // Solo permitir mover dentro del mismo curso (misma fila)
    if (originCurso !== targetCurso) return false;
    const ocupado = slotOcupado(slot);
    // Si est√° ocupado, permitir solo si es el mismo curso (swap). Ya garantizado arriba.
    // Prevalidar conflicto de profesor en otros cursos
    const ignorar = new Set([item.dataset.id]);
    const existing = slot.querySelector('.draggable-item');
    if (existing) ignorar.add(existing.dataset.id); // Ignorar ocupante en caso de swap dentro del mismo curso
    if (hayConflictoProfesor(profesor, dia, bloque, ignorar, originCurso)) return false;
    return true;
  }

  async function enviarMovimiento(horarioId, nuevoDia, nuevoBloque, originSlot, targetSlot, swappedCard) {
    const csrftoken = getCookie('csrftoken');
    try {
      const res = await fetch('/mover-horario-ajax/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          horario_id: horarioId,
          nuevo_dia: nuevoDia,
          nuevo_bloque: nuevoBloque
        })
      });
      const data = await res.json();
      if (!res.ok || data.error) {
        // Revertir UI si hay error del servidor (validaci√≥n profesor ocupado, etc.)
        if (dragItem && originSlot) originSlot.appendChild(dragItem);
        if (swappedCard && targetSlot) targetSlot.appendChild(swappedCard);
        mostrarMensaje(`‚ùå ${data.error || 'Movimiento inv√°lido'}`, 'error');
        return false;
      }
      mostrarMensaje('‚úÖ Movimiento aplicado', 'success');
      return true;
    } catch (err) {
      if (dragItem && originSlot) originSlot.appendChild(dragItem);
      if (swappedCard && targetSlot) targetSlot.appendChild(swappedCard);
      mostrarMensaje(`‚ùå Error de red: ${err}`, 'error');
      return false;
    }
  }
  // Document-level handlers to ensure droppable cursor over nested elements
  document.addEventListener('dragover', (e) => {
    const slot = e.target.closest && e.target.closest('.slot-celda');
    if (!slot) return;
    const allowed = esDropPermitido(dragItem, slot);
    if (allowed) {
      e.preventDefault();
      if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
      if (hover && hover !== slot) {
        hover.classList.remove('ring-2','ring-green-500/60','border-dashed','ring-red-500/70','cursor-not-allowed');
      }
      slot.classList.add('ring-2','ring-green-500/60','border-dashed');
      slot.classList.remove('ring-red-500/70','cursor-not-allowed');
    } else {
      e.preventDefault();
      if (e.dataTransfer) e.dataTransfer.dropEffect = 'none';
      if (hover && hover !== slot) {
        hover.classList.remove('ring-2','ring-green-500/60','border-dashed','ring-red-500/70','cursor-not-allowed');
      }
      slot.classList.add('ring-2','ring-red-500/70','cursor-not-allowed');
      slot.classList.remove('ring-green-500/60','border-dashed');
    }
    hover = slot;
  }, true);
  document.addEventListener('drop', (e) => {
    const slot = e.target.closest && e.target.closest('.slot-celda');
    if (!slot) return;
    e.preventDefault();
    slot.classList.remove('ring-2','ring-green-500/60','border-dashed','ring-red-500/70','cursor-not-allowed');
    hover = null;
    if (!dragItem || slot === origin) return;

    // Prevalidaci√≥n estricta
    if (!esDropPermitido(dragItem, slot)) {
      mostrarMensaje('‚ùå Movimiento no permitido: bloque ocupado o conflicto de profesor', 'error');
      return;
    }

    const existing = slot.querySelector('.draggable-item'); // Por regla 1 no deber√≠a existir
    const originSlot = origin;
    const targetSlot = slot;

    // Leer destino
    const horarioId = dragItem.dataset.id;
    const nuevoDia = targetSlot.dataset.dia;
    const nuevoBloque = targetSlot.dataset.bloque;

    // Movimiento optimista en UI
    if (existing) originSlot.appendChild(existing);
    targetSlot.appendChild(dragItem);

    // Validar y persistir en servidor (revierte si falla)
    enviarMovimiento(horarioId, nuevoDia, nuevoBloque, originSlot, targetSlot, existing);
  }, true);
  document.querySelectorAll('.slot-celda').forEach(s => {
    s.addEventListener('dragover', e => { 
      // Manejado por document-level
      e.preventDefault();
    });
    s.addEventListener('dragenter', e => { e.preventDefault(); });
    s.addEventListener('dragleave', () => {});
    s.addEventListener('drop', e => {
      // Drop centralizado arriba
      e.preventDefault();
    });
  });
  document.querySelectorAll('.draggable-item').forEach(d => {
    d.addEventListener('dragstart', e => {
      dragItem = d;
      origin = d.parentElement;
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain', d.id || 'card'); } catch(_) {}
      d.classList.add('opacity-70');
      // Resaltar todos los slots permitidos
      document.querySelectorAll('.slot-celda').forEach(s => {
        if (esDropPermitido(d, s)) {
          s.classList.add('ring-2','ring-green-500/60','border-dashed');
        } else {
          s.classList.add('ring-2','ring-red-500/50','cursor-not-allowed');
        }
      });
    });
    d.addEventListener('dragend', () => {
      if (dragItem) dragItem.classList.remove('opacity-70');
      dragItem = null;
      origin = null;
      document.querySelectorAll('.slot-celda').forEach(el => el.classList.remove('ring-2','ring-green-500/60','border-dashed','ring-red-500/50','cursor-not-allowed'));
    });
  });
}

// Helper para obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Funcionalidad Drag and Drop (legado para otras vistas antiguas)
function initDragAndDropLegacy() {
  const draggables = document.querySelectorAll('.draggable-item');
  const dropTargets = document.querySelectorAll('.drop-target');
  
  draggables.forEach(draggable => {
    draggable.addEventListener('dragstart', () => {
      draggable.classList.add('opacity-50', 'scale-105', 'shadow-lg');
      draggable.classList.add('dragging');
      // Guardar ID del horario
      draggable.dataset.sourceDia = draggable.closest('td').dataset.dia;
      draggable.dataset.sourceBloque = draggable.closest('td').dataset.bloque;
    });

    draggable.addEventListener('dragend', () => {
      draggable.classList.remove('opacity-50', 'scale-105', 'shadow-lg');
      draggable.classList.remove('dragging');
      
      // Limpiar clases de highlight de todos los targets
      dropTargets.forEach(target => {
        target.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-400', 'ring-inset');
      });
    });
  });

  dropTargets.forEach(target => {
    target.addEventListener('dragover', (e) => {
      e.preventDefault(); // Necesario para permitir drop
      const draggingItem = document.querySelector('.dragging');
      if (draggingItem) {
        // Solo resaltar si es una celda diferente
        if (target !== draggingItem.closest('td')) {
            target.classList.add('bg-blue-100', 'ring-2', 'ring-blue-400', 'ring-inset');
        }
      }
    });

    target.addEventListener('dragleave', () => {
      target.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-400', 'ring-inset');
    });

    target.addEventListener('drop', (e) => {
      e.preventDefault();
      target.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-400', 'ring-inset');
      
      const draggable = document.querySelector('.dragging');
      if (!draggable) return;
      
      const sourceTd = draggable.closest('td');
      
      // Si soltamos en la misma celda, no hacer nada
      if (target === sourceTd) return;

      // Detectar si hay un elemento existente para hacer SWAP
      const existingItem = target.querySelector('.draggable-item');
      
      // Si hay un item existente, hacemos swap visual
      if (existingItem) {
          // Mover el existente al origen
          sourceTd.appendChild(existingItem);
          // Mover el arrastrado al destino
          target.appendChild(draggable);
          mostrarNotificacion('üîÑ Intercambiando horarios...', 'info');
      } else {
          // Mover simple
          target.appendChild(draggable);
          mostrarNotificacion(`üîÑ Guardando cambio...`, 'info');
      }
      
      // Datos para actualizar
      const horarioId = draggable.dataset.horarioId;
      const nuevoDia = target.dataset.dia;
      const nuevoBloque = target.dataset.bloque;
      
      // Llamada AJAX al backend
      fetch('/mover-horario-ajax/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              horario_id: horarioId,
              nuevo_dia: nuevoDia,
              nuevo_bloque: nuevoBloque
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              mostrarNotificacion('‚úÖ Cambio guardado correctamente', 'success');
              // Actualizar metadatos del item movido
              // Nota: No necesitamos actualizar mucho porque la posici√≥n DOM ya es correcta
          } else {
              mostrarNotificacion(`‚ùå Error: ${data.error}`, 'error');
              // Revertir cambio visualmente si falla
              if (existingItem) {
                  target.appendChild(existingItem);
                  sourceTd.appendChild(draggable);
              } else {
                  sourceTd.appendChild(draggable);
              }
          }
      })
      .catch(error => {
          console.error('Error:', error);
          mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
          // Revertir cambio
          if (existingItem) {
              target.appendChild(existingItem);
              sourceTd.appendChild(draggable);
          } else {
              sourceTd.appendChild(draggable);
          }
      });
    });
  });
}
</script>
